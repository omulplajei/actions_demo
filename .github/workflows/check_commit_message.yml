name: 'Check Commit Msg'
on:
  push:
    branches:
      - master
      - 'releases/*'

jobs:
  check_last_commit_message:
    name: Check Commit Msg
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.sha }}

      - name: Get Commit Message
        run: |
          MSG=$(git log --format=%B -n 1 ${{ github.event.after }})
          echo "::set-env name=COMMIT_MESSAGE::${MSG}"

      - name: Validate Message
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ env.COMMIT_MESSAGE }}
          regex: '^((TP|#|US)[0-9]+).+$'
          flags: gm

      - name: Fail If Validation Failed
        run: |
          echo 'Commit message format must be one of "TP12345/US12345/#12345 - message".'
          exit 1
        if: ${{ steps.regex-match.outputs.match == '' }}
